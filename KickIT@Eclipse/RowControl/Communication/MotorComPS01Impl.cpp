#include <iostream>
#include <stdio.h>
#include <unistd.h>
#include "MotorComPS01Impl.hpp"

using namespace std;

MotorComPS01Impl::MotorComPS01Impl(Row r) {
	this->socketId = 0;
	this->port = "can0";
	this->row = r;
	driverInit();
}

void MotorComPS01Impl::kick() {
	cout << "kick() is not implemented" << endl;
}

void MotorComPS01Impl::homing() {
	cout << "homing() is not implemented" << endl;
}

void MotorComPS01Impl::driverInit() {
	cout << "driverInit() PS01:" << endl;

	cout << "(1/6) Reset" << endl;
	frameInit(0x601, 0x8, 0x23, 0x00, this->switchedNibbleT(), 0xB, 0x00, 0x00, 0x00, 0x00);
	sleep(20);

	cout << "(2/6) Operational" << endl;
	frameInit(0x00, 0x2, 0x01, 0x00, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	sleep(2);

	cout << "(3/6) Ready to switch on" << endl;
	frameInit(0x201, 0x8, 0x3E, 0x00, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
	sleep(2);

	cout << "(4/6) Switching on" << endl;
	frameInit(0x201, 0x8, 0x3F, 0x00, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
	sleep(2);

	cout << "(5/6) Homing" << endl;
	frameInit(0x201, 0x8, 0x3F, 0x08, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
	sleep(25);

	cout << "(6/6) Homed\n" << endl;
	frameInit(0x201, 0x8, 0x3F, 0x00, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
}

void MotorComPS01Impl::linearMovement(int position){
	if(position > 77) position = 77;			//Check if position is within range
	if(position < -80) position = -80;			//Check if position is within range

	int pos1, pos2;
	position *= 10;
	pos1 = (position & 255);
	pos2 = (position >> 8);

	frameInit(0x201, 0x8, 0x3F, 0x00, this->switchedNibbleT(), 0x09, pos1, pos2, 0xFF, 0xFF);
	frameInit(0x301, 0x8, 0x2C, 0x01, 0x2C, 0x01, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
}

//BITTE STEHEN LASSEN, WEGEN DER SICHERHEIT!
/*
if (!this->initNibblePStranslational) {
	cout << "(1/6) Reset Initial" << endl;
	//frameInit(0x601, 0x8, 0x23, 0x00, this->switchedNibbleT(), 0xB, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x601, 0x8, 0x23, 0x00, 0x20, 0xB, 0x00, 0x00, 0x00, 0x00);
	sleep(20);

	cout << "(2/6) Operational Initial" << endl;
	//frameInit(0x00, 0x2, 0x01, 0x00, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x00, 0x2, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
	sleep(2);

	cout << "(3/6) Ready to switch on Initial" << endl;
	//frameInit(0x201, 0x8, 0x3E, 0x00, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	//frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x201, 0x8, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
	sleep(2);

	this->initNibblePStranslational = true;
} else {
	cout << "(1/6) Reset" << endl;
	frameInit(0x601, 0x8, 0x23, 0x00, this->switchedNibbleT(), 0xB, 0x00, 0x00, 0x00, 0x00);
	sleep(20);

	cout << "(2/6) Operational" << endl;
	frameInit(0x00, 0x2, 0x01, 0x00, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	sleep(2);

	cout << "(3/6) Ready to switch on" << endl;
	frameInit(0x201, 0x8, 0x3E, 0x00, this->switchedNibbleT(), 0x00, 0x00, 0x00, 0x00, 0x00);
	frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
	sleep(2);
}

cout << "(4/6) Switching on" << endl;
frameInit(0x201, 0x8, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
sleep(2);

cout << "(5/6) Homing" << endl;
frameInit(0x201, 0x8, 0x3F, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
sleep(25);

cout << "(6/6) Homed\n" << endl;
frameInit(0x201, 0x8, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
frameInit(0x80, 0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);
*/
